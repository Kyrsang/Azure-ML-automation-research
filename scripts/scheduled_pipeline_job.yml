$schema: https://azuremlschemas.azureedge.net/latest/pipelineJob.schema.json
type: pipeline
display_name: scheduled_pipeline
compute: azureml:eunsang-ml-research

jobs:
  prepare_dataset:
    command: |

      # Create dataset and capture the JSON response
      DATA_OUTPUT=$(az ml data create --name iris-dataset \
        --path /app/datasets/iris.csv \
        --type uri_file \
        --workspace-name inbrein-azure-ml-research-eunsang \
        --resource-group inbrein-azure-ml-research \
        --output json)

      # Extract the name and version using jq
      DATASET_NAME=$(echo $DATA_OUTPUT | jq -r '.name')
      DATASET_VERSION=$(echo $DATA_OUTPUT | jq -r '.version')

      # Format the output as azureml:<name>:<version>
      DATASET_PATH="azureml:${DATASET_NAME}:${DATASET_VERSION}"

      # Save the formatted path to an output file
      echo $DATASET_PATH > ${{outputs.dataset_path}}/dataset_path.txt

    environment:
      image: eunsangacr.azurecr.io/azureml-with-azcli:latest
    outputs:
      dataset_path:

  setup_automl:
    command: |
      # Read the dataset path from the input file
      DATA_PATH=$(cat ${{inputs.dataset_input}}/dataset_path.txt)

      # Create automl job using the dataset path
      az ml job create --file /app/configs/automl_settings.yml \
        --set training_data.path=${DATA_PATH} \
        --workspace-name inbrein-azure-ml-research-eunsang \
        --resource-group inbrein-azure-ml-research

    environment:
      image: eunsangacr.azurecr.io/azureml-with-azcli:latest  
    inputs:
      dataset_input: ${{parent.jobs.prepare_dataset.outputs.dataset_path}} 
